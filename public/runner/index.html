<!doctype html>
<meta charset=utf-8>
<title>JS Bin Runner</title>

<style type="text/css">
  body {
    margin: 0;
    padding: 0;
    background: transparent;
  }
  iframe {
    border: none;
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    height: 100%;
    width: 100%;
  }
</style>

<div id="sandbox-wrapper"></div>

<script type="text/javascript">

/**
 * Polyfills
 */

Element.prototype.prependChild = function(child) { this.insertBefore(child, this.firstChild); };
var addEvent = function(elem, event, fn) {
  if (elem.addEventListener) {
    elem.addEventListener(event, fn, false);
  } else {
    elem.attachEvent("on" + event, function() {
      // set the this pointer same as addEventListener when fn is called
      return(fn.call(elem, window.event));
    });
  }
}

/**
 * Sandbox
 * Handles creating and insertion of dynamic iframes
 */
var sandbox = (function () {

  var sandbox = {};

  /**
   * Save the target container element, plus the old and active iframes.
   */
  sandbox.target = null;
  sandbox.old = null;
  sandbox.active = null;

  /**
   * Create a new sandboxed iframe.
   */
  sandbox.create = function () {
    var iframe = document.createElement('iframe');
    iframe.setAttribute('sandbox', 'allow-forms allow-pointer-lock allow-popups allow-same-origin allow-scripts');
    iframe.setAttribute('frameBorder', '0');
    return iframe;
  }

  /**
   * Add a new iframe to the page and wait until it has loaded to call the
   * requester back. Also wait until the new iframe has loaded before removing
   * the old one.
   */
  sandbox.use = function (iframe, done) {
    if (!sandbox.target) throw new Error("Sandbox has no target element.");
    sandbox.old = sandbox.active;
    sandbox.active = iframe;
    sandbox.target.prependChild(iframe);
    // setTimeout allows the iframe to be rendered before other code runs,
    // allowing us access to the calculated properties like innerWidth.
    setTimeout(done, 0);
    // Wait until the new iframe has loaded to remove the old one
    addEvent(iframe, 'load', function () {
      if (sandbox.old) {
        sandbox.old.parentNode.removeChild(sandbox.old);
      }
    })
  };

  return sandbox;

}());

/**
 * JS Bin Runner
 * Accepts incoming postMessage events and updates a live iframe accordingly.
 */
var runner = (function () {

  var runner = {};

  /**
   * Store what parent origin *should* be
   * TODO this should allow anything if x-origin protection should be disabled
   */
  runner.parentOrigin = window.location.origin.replace('run.', '');

  /**
   * Log error messages, indicating that it's from the runner.
   * TODO proxy these up to the parent
   */
  runner.error = function () {
    console.error.apply(console, ['Runner:'].concat([].slice.call(arguments)));
  };

  /**
   * Handle all incoming postMessages to the runnder
   */
  runner.handleMessage = function (event) {
    if (event.origin !== runner.parentOrigin) {
      return runner.error('Message disallowed, incorrect origin:', event.origin);
    }
    if (typeof runner[event.data.type] !== 'function') {
      return runner.error('No matching event handler:', event.data.type);
    }
    try {
      runner[event.data.type](event.data.data);
    } catch (e) {
      runner.error(e.message);
    }
  };

  /**
   * Render a new preview iframe using the posted source
   */
  runner.render = function (source) {
    var iframe = sandbox.create();
    sandbox.use(iframe, function () {
      var doc = iframe.contentDocument || iframe.contentWindow.document,
          win = doc.defaultView || doc.parentWindow;
      doc.open();
      doc.write(source);
      doc.close();
    });
  };

  return runner;

}());

window.onload = function () {

  // Set the sandbox target
  sandbox.target = document.getElementById('sandbox-wrapper');

  console.log(sandbox.target);

  /**
   * Live rendering, basic mode.
   * Fallback - load the bin into a new iframe, and let it keep itself up
   * to date using event stream.
   */
  if (!window.postMessage) {
    var iframe = sandbox.create();
    sandbox.use(iframe);
    iframe.src = window.name;
    return;
  }

  /**
   * Live rendering, postMessage style.
   */
  window.onmessage = runner.handleMessage;

};
</script>